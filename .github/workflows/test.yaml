name: CI
on:  [workflow_dispatch, pull_request, push]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install CUDA dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git \
            build-essential \
            libhdf5-dev \
            python3-pip \
            python3-dev \
            sudo \
            wget
          
      - name: Install PyTorch with CUDA
        run: |
          pip install torch --extra-index-url https://download.pytorch.org/whl/cu121
          
      - name: Install project dependencies
        run: |
          pip install seaborn scikit-learn umap-learn h5py matplotlib plotly pandas pytorch-lightning fastdtw papermill
          pip install wandb pytest
          pip install ipykernel jupyter nbdev
          nbdev_install_quarto
          
      # Add this step to properly clean notebooks before testing
      - name: Setup Git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Clean and prepare notebooks
        run: |
          echo "Installing latest nbdev..."
          pip install -U nbdev
          
          echo "Setting up nbdev hooks..."
          nbdev_install_hooks
          
          echo "Cleaning notebooks..."
          nbdev_clean
          
          echo "Checking if notebooks are properly cleaned..."
          if [[ -n "$(git status --porcelain -uno)" ]]; then
            echo "Some notebooks need cleaning. Auto-committing changes..."
            git add -A
            git commit -m "Auto-clean notebooks [CI]"
          else
            echo "All notebooks are clean."
          fi
          
      - name: Install Julia
        run: |
          echo "Installing Julia..."
          wget https://julialang-s3.julialang.org/bin/linux/x64/1.10/julia-1.10.5-linux-x86_64.tar.gz
          tar -xvzf julia-1.10.5-linux-x86_64.tar.gz
          sudo mv julia-1.10.5 /opt/julia
          sudo ln -s /opt/julia/bin/julia /usr/local/bin/julia
          rm julia-1.10.5-linux-x86_64.tar.gz
          echo "Julia version:"
          julia --version
          echo "Julia path:"
          which julia
          
      - name: Set up Julia environment
        run: |
          echo "Setting up Julia environment..."
          export JULIA_DEPOT_PATH=/opt/julia_depot
          mkdir -p $JULIA_DEPOT_PATH
          echo "JULIA_DEPOT_PATH: $JULIA_DEPOT_PATH"
          
          echo "Installing Julia packages..."
          # Match exactly the packages listed in the Dockerfile
          julia -e 'using Pkg; Pkg.add(["DifferentialEquations", "Polynomials", "LinearAlgebra", "MAT", "NPZ"])'
          
          # Add PyCall explicitly as the Dockerfile might be missing this
          julia -e 'using Pkg; Pkg.add("PyCall")'
          
          echo "Setting up IJulia..."
          julia -e 'using Pkg; Pkg.add("IJulia"); using IJulia; IJulia.installkernel("Julia")'
          
      - name: Install and configure PyJulia
        run: |
          echo "Installing PyJulia..."
          pip install julia
          
          echo "Setting PYTHON environment variable for PyCall..."
          export PYTHON=$(which python)
          echo "PYTHON set to: $PYTHON"
          
          # Set environment variables for Julia-Python interoperability
          export JULIA_PYTHONCALL_EXE=$(which python)
          
          # Make sure PyCall is properly installed and then build it
          echo "Installing and building PyCall with the correct Python..."
          julia -e '
          ENV["PYTHON"]="'$(which python)'";
          using Pkg;
          
          # Check if PyCall is installed, install if not
          if !haskey(Pkg.project().dependencies, "PyCall")
              println("Installing PyCall...");
              Pkg.add("PyCall");
          end
          
          # Install DifferentialEquations in the same environment
          if !haskey(Pkg.project().dependencies, "DifferentialEquations")
              println("Installing DifferentialEquations...");
              Pkg.add("DifferentialEquations");
          end
          
          # Also add other required packages
          for pkg in ["Polynomials", "LinearAlgebra", "MAT", "NPZ"]
              if !haskey(Pkg.project().dependencies, pkg)
                  println("Installing ", pkg, "...");
                  Pkg.add(pkg);
              end
          end
          
          # Now build PyCall with the correct Python
          println("Building PyCall...");
          Pkg.build("PyCall");
          
          # Verify PyCall works
          println("Testing PyCall...");
          using PyCall;
          println("PyCall successfully loaded");
          
          # Verify DifferentialEquations works
          println("Testing DifferentialEquations...");
          using DifferentialEquations;
          println("DifferentialEquations successfully loaded");
          '
          
          # Initialize PyJulia (as done in the Dockerfile)
          echo "Initializing PyJulia..."
          python -c "import julia; julia.install()"
          
          # Test the complete Julia-Python interoperability
          echo "Testing complete Julia-Python integration..."
          python -c "from julia.api import Julia; jl = Julia(compiled_modules=False); from julia import Main; print('Julia-Python bridge established'); Main.eval('println(\"Testing imports:\")'); Main.eval('using PyCall; println(\"PyCall loaded\")'); Main.eval('using DifferentialEquations; println(\"DifferentialEquations loaded\")')"
          
          # Export environment variables for later steps
          echo "JULIA_DEPOT_PATH=${JULIA_DEPOT_PATH}" >> $GITHUB_ENV
          echo "PYTHON=$(which python)" >> $GITHUB_ENV
          echo "JULIA_PYTHONCALL_EXE=$(which python)" >> $GITHUB_ENV
          
      # Add a step to prepare notebooks for Julia execution
      - name: Prepare notebooks for Julia execution
        run: |
          echo "Ensuring PyCall is in the default environment..."
          julia -e 'using Pkg; Pkg.activate(); if !haskey(Pkg.project().dependencies, "PyCall") Pkg.add("PyCall"); end; Pkg.build("PyCall"); using PyCall; println("PyCall successfully loaded in default environment")'
          
          echo "Checking and installing DifferentialEquations if needed..."
          julia -e 'using Pkg; Pkg.activate(); if !haskey(Pkg.project().dependencies, "DifferentialEquations") Pkg.add("DifferentialEquations"); end; using DifferentialEquations; println("DifferentialEquations successfully loaded in default environment")'
          
          echo "Creating a Julia module to test PyCall and Julia integrations..."
          cat > test_julia_python.py << EOF
          from julia.api import Julia
          jl = Julia(compiled_modules=False)
          from julia import Main
          
          # Test importing PyCall from Julia
          Main.eval('println("Testing PyCall import from Julia:"); using PyCall; println("PyCall successfully imported")')
          
          # Test importing DifferentialEquations from Julia
          Main.eval('println("Testing DifferentialEquations import from Julia:"); using DifferentialEquations; println("DifferentialEquations successfully imported")')
          EOF
          
          echo "Running Julia-Python integration test..."
          python test_julia_python.py
          
      - name: Run nbdev CI
        uses: fastai/workflows/nbdev-ci@master
